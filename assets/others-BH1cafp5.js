import{g as e,a as t}from"./bitcoin-utils-DDv8QE7C.js";import{s as n,e as s,B as o}from"./bitcoin-CpxUx-D2.js";import{o as a,W as r,n as i,T as d,h as l}from"./notification-DTttb5yl.js";const c=document.getElementById("currentBlock"),u=document.getElementById("durationSelect"),p=document.getElementById("lockDate"),m=document.getElementById("lockHeightInput");let g=0,h=null;async function f(){try{const e=localStorage.getItem("walletAddress"),t=await fetch("https://omrapi.vercel.app/leaderboard-others"),n=await t.json(),s=document.getElementById("leaderboardBody"),o=document.getElementById("totalPower");if(!n?.length)return void(s.innerHTML="<tr><td colspan='7' style='color: #cccccc; font-size: 15px; padding: 20px; text-align: center;'>No stakers yet.</td></tr>");s.innerHTML="";let a=0;if(n.forEach((t,n)=>{const o=Number(t.totalPoints||0),r=Number(t.dailyPoints||0),i=t.tierMultiplier?.toFixed(1)||"1.0",d=t.nftCount||0,l=t.userAddress,c=l?`${l.slice(0,6)}...${l.slice(-6)}`:"-";a+=o;const u=document.createElement("tr");u.classList.toggle("my-wallet",l===e),u.innerHTML=`\n          <td class="rank rank-${n+1}">${n+1}</td>\n          <td>${c}</td>\n          <td>${d}</td>\n          <td>${i}√ó</td>\n          <td>${r.toFixed(0)}</td>\n          <td>${o.toFixed(0)}</td>\n        `,s.appendChild(u)}),o.innerHTML=`üî• Total Points: ${a.toLocaleString()}`,e){const t=n.findIndex(t=>t.userAddress===e);t>=0&&(o.innerHTML+=`<br>ü™© Your Rank: #${t+1}`)}}catch(e){}}async function y(){try{return g=await e(),c.textContent=g.toLocaleString(),g}catch(t){return g||0}}async function w(t=null){try{const n=await e(),s=144,o=2,a=t??h??parseFloat(u.value);if(!a||isNaN(a))return;const r=Math.floor(100*a)/100,i=n+Math.round(r*s)+o;m.value=i}catch(n){}}function v(e){return e.replace(/i\d+$/,"")}f(),setInterval(f,3e4),u.addEventListener("change",async()=>{const e=parseFloat(u.value);if(!e||isNaN(e))return;h=e;const t=new Date((new Date).getTime()+24*e*60*60*1e3);p.valueAsDate=t,await w(e)}),p.addEventListener("change",()=>w()),(async()=>{await y(),await w(),setInterval(y,3e4)})();const b=new Map(a.map(e=>[v(e.id),e]));n.initEccLib(s),window.Buffer=o;const k=new r;let x=[],I=[],E=new Set,S=0,B=null,T=null;const L=document.getElementById("statusText"),$=document.getElementById("btnConnect"),P=document.getElementById("btnConnectPanel"),A=document.getElementById("btnLogout"),C=document.getElementById("inscriptionPanel"),N=document.getElementById("inscriptionCount"),M=document.getElementById("inscriptionGrid"),K=document.getElementById("selectedSection"),H=document.getElementById("timelockPanel"),F=document.getElementById("selectedCount"),O=document.getElementById("btnTimelock");document.getElementById("btnRedeem");const j=document.getElementById("feeRate"),X=document.getElementById("lockHeightInput");document.getElementById("estAddress"),document.getElementById("estFee"),document.getElementById("estTotal");const z=document.getElementById("estimateBox"),U=document.getElementById("estFee"),D=document.getElementById("estTotal"),q=document.getElementById("estAddress"),_=document.getElementById("currentBlock"),J=document.getElementById("lockedListBody"),R=document.getElementById("lockedListPanel");function Y(e){const t=document.getElementById("btnTimelock"),n=document.getElementById("btnTimelockXverse");t&&n&&("unisat"===e?(t.classList.remove("hidden"),n.classList.add("hidden")):"xverse"===e?(n.classList.remove("hidden"),t.classList.add("hidden")):(t.classList.add("hidden"),n.classList.add("hidden")))}async function W(){try{L.textContent="üß© Connecting...",k.connected=!1,B=null,T=null;let e,t,n=localStorage.getItem("walletType");if(n||(n=await new Promise(e=>{const t=document.createElement("div");t.innerHTML='\n    <div id="walletModalOverlay" style="\n      position: absolute;                     /* ‚úÖ absolute so it follows page scroll */\n      top: 0;\n      left: 0;\n      right: 0;\n      min-height: 100vh;                      /* ‚úÖ covers full page height */\n      background: rgba(0,0,0,0.85);\n      backdrop-filter: blur(5px);\n      -webkit-backdrop-filter: blur(5px);\n      display: flex;\n      justify-content: center;\n      align-items: flex-start;\n      overflow-y: auto;                       /* ‚úÖ allows scroll if content tall */\n      padding: 18vh 20px 60px 20px;           /* ‚úÖ positions modal near top */\n      box-sizing: border-box;\n      z-index: 9999;\n    ">\n      <div id="walletModalBox" style="\n        background: #111;\n        border: 2px solid #f97316;\n        border-radius: 16px;\n        padding: 40px 30px;\n        color: white;\n        text-align: center;\n        max-width: 420px;\n        width: 90%;\n        box-shadow: 0 0 40px rgba(249,115,22,0.4);\n        font-family: Inter, sans-serif;\n        max-height: calc(100vh - 80px);       /* ‚úÖ safe height */\n        overflow-y: auto;\n        scrollbar-width: thin;\n        scrollbar-color: rgba(255,255,255,0.2) transparent;\n      ">\n        <h2 style="font-size:1.6rem;margin-bottom:20px;">üîó Select Your Wallet</h2>\n        <p style="color:#bbb;font-size:0.95rem;margin-bottom:30px;">\n          Choose a wallet provider to connect your account.\n        </p>\n        <div style="display:flex;flex-direction:column;gap:16px;align-items:center;">\n          <button id="chooseUnisat" style="\n            width:80%;\n            padding:14px 20px;\n            font-size:1.1rem;\n            background:#f97316;\n            border:none;\n            border-radius:10px;\n            color:#000;\n            cursor:pointer;\n            font-weight:600;\n            transition:all 0.2s ease-in-out;\n          ">ü¶ä Connect with Unisat</button>\n          <button id="chooseXverse" style="\n            width:80%;\n            padding:14px 20px;\n            font-size:1.1rem;\n            background:#2b2b2b;\n            border:1px solid #666;\n            border-radius:10px;\n            color:#fff;\n            cursor:pointer;\n            font-weight:600;\n            transition:all 0.2s ease-in-out;\n          ">üåÄ Connect with Xverse</button>\n        </div>\n        <p style="margin-top:30px;font-size:0.85rem;color:#777;">\n          Make sure your wallet extension is installed and unlocked.\n        </p>\n      </div>\n    </div>\n  ',document.body.appendChild(t);const n=window.scrollY||document.documentElement.scrollTop,s=t.querySelector("#walletModalOverlay");s.style.top=`${n}px`,s.style.height=`${document.body.scrollHeight}px`;const o=()=>{t.remove()};s.querySelector("#chooseUnisat").onclick=()=>{o(),e("unisat")},s.querySelector("#chooseXverse").onclick=()=>{o(),e("xverse")},s.addEventListener("click",t=>{t.target===s&&(o(),e(null))}),window.addEventListener("keydown",t=>{"Escape"===t.key&&(o(),e(null))},{once:!0}),setTimeout(()=>{document.getElementById("walletModalBox").scrollIntoView({behavior:"smooth",block:"center"})},100)})),"unisat"===n){if(!window.unisat)throw new Error("ü¶ä Unisat wallet not detected.");e=(await window.unisat.requestAccounts())[0],t=await window.unisat.getPublicKey(),k.address=e,k.publicKey=t,k.connected=!0,localStorage.setItem("walletType","unisat"),localStorage.setItem("walletAddress",e),localStorage.setItem("walletPublicKey",t)}else if("xverse"===n){const n=window?.XverseProviders?.BitcoinProvider;if(!n)throw new Error("‚ùå Xverse wallet not injected.");const s=await n.request("wallet_connect",{network:"Mainnet",addresses:["ordinals","payment"],message:"Connect to this dApp"});if(s.error)throw new Error(s.error.message);const o=s.result?.addresses||s.addresses,a=o.find(e=>"ordinals"===e.purpose),r=o.find(e=>"payment"===e.purpose);if(!a||!r)throw new Error("Missing ordinals or payment address.");!function(e){B=e,k.taproot=e.address,localStorage.setItem("taprootAddress",e.address),localStorage.setItem("taprootPublicKey",e.publicKey);const t=document.getElementById("taprootAddr");t&&(t.textContent=e.address)}(a),function(e){T=e,k.payment=e.address,localStorage.setItem("paymentAddress",e.address),localStorage.setItem("paymentPublicKey",e.publicKey);const t=document.getElementById("paymentAddr");t&&(t.textContent=e.address)}(r),e=a.address,t=a.publicKey,k.address=e,k.publicKey=t,k.connected=!0,localStorage.setItem("walletType","xverse"),localStorage.setItem("walletAddress",e),localStorage.setItem("walletPublicKey",t)}Y(n),V(e),I.length||await Z(),""===J.innerHTML.trim()&&await se(),i.success(`${n.toUpperCase()} connected`,`Connected: ${e.slice(0,8)}‚Ä¶${e.slice(-8)}`),L.textContent=`‚úÖ Connected: ${e.slice(0,8)}‚Ä¶${e.slice(-8)}`}catch(e){i.error(e.message,"Connection Failed"),Q(),G()}}function G(){["walletType","walletAddress","walletPublicKey","taprootAddress","taprootPublicKey","paymentAddress","paymentPublicKey"].forEach(e=>localStorage.removeItem(e))}function V(e){const t=localStorage.getItem("walletType");L.textContent=`‚úÖ Connected: ${e.slice(0,6)}...${e.slice(-6)}`,$.style.display="none",P.style.display="none",A.style.display="inline-block",C.classList.remove("hidden"),Y(t)}function Q(){L.textContent="üîå Not Connected",$.style.display="inline-block",P.style.display="inline-block",A.style.display="none",C.classList.add("hidden"),H.classList.add("hidden"),K.classList.add("hidden"),R.classList.add("hidden"),Y(null)}async function Z(){try{x=await k.getInscriptions_Other();const t=JSON.parse(localStorage.getItem("timelockAddresses")||"[]"),n=new Set(t.map(e=>e.nftId)),s=localStorage.getItem("walletAddress");if(s)try{const e=await fetch(`https://omrapi.vercel.app/locksothers?userAddress=${s}`);e.ok&&(await e.json()).forEach(e=>{e.nftId&&n.add(e.nftId)})}catch(e){}const o=x.map(e=>({...e,id:e.id||e.inscriptionId||e.inscription_id||null})).filter(e=>e.id&&!n.has(e.id));I=o.filter(e=>{return t=e.id,!b.has(v(t));var t}),async function(){N.textContent=`Showing ${I.length}`;const e=document.createDocumentFragment();for(const t of I){const n=document.createElement("div");n.className="inscription-card "+(E.has(t.id)?"selected":""),n.dataset.id=t.id;const s=document.createElement("div");s.className="inscription-preview";const o=t.id,a=`https://ordinals.com/content/${o}`,r=`https://renderer.magiceden.dev/v2/render?id=${o}&forceResize=true&useObjectTag=false&noBackground=false`,i=document.createElement("img");i.alt=t.name||t.meta?.name||o,i.loading="lazy",i.referrerPolicy="no-referrer",i.decoding="async",i.src=t.image||t.high_res_img_url||t.meta?.high_res_img_url||r,i.style="\n      width: 100%;\n      height: auto;\n      border-radius: 10px;\n      display: block;\n      background: #111;\n      transition: opacity 0.3s ease-in-out;\n      opacity: 0;\n    ",i.onload=()=>i.style.opacity="1";let d=!1,l=!1;i.onerror=()=>{d||i.src===r?l||i.src===a?(i.onerror=null,i.src="fallback.png"):(l=!0,i.src=a):(d=!0,i.src=r)},s.appendChild(i);const c=t.name||t.meta?.name||`#${o.slice(0,6)}...`,u=document.createElement("div");u.className="inscription-info",u.innerHTML=`<div>${c}</div>`,n.appendChild(s),n.appendChild(u),n.addEventListener("click",()=>{return e=t,E.has(e.id)?E.delete(e.id):E.add(e.id),void ee();var e}),e.appendChild(n)}M.innerHTML="",M.appendChild(e)}(),N.textContent=`Showing ${I.length}`,requestAnimationFrame(()=>{M.style.scrollBehavior="auto"})}catch(e){i.error("Failed to load your inscriptions","Load Error")}}function ee(){document.querySelectorAll(".inscription-card").forEach(e=>{const t=e.dataset.id;e.classList.toggle("selected",E.has(t))}),E.size>0?(K.classList.remove("hidden"),H.classList.remove("hidden"),F.textContent=E.size,te()):(K.classList.add("hidden"),H.classList.add("hidden"))}function te(){const e=parseInt(j.value)||1,n=parseInt(X.value),s=E.size||0;if(0===s)return U.textContent="0 sats",D.textContent="0 sats",q.textContent="-",void z.classList.add("hidden");const o=50+0*(s+2)+70*(s+3),a=Math.ceil(o*e*1.1);let r;r=1===s?380:2===s?340:3===s?310:4===s?290:270;const i=Math.ceil(r*e)*s*.9,d=[1,.9,.8,.7,.6];let l=0;for(let t=0;t<s;t++)l+=1500*(d[t]||1);const c=546*s+i+l+a,u=document.getElementById("estRedeem"),p=document.getElementById("estMarket");U.textContent=`${a.toLocaleString()} sats`,D.textContent=`${c.toLocaleString()} sats`,u&&(u.textContent=`${i.toLocaleString()} sats`),p&&(p.textContent=`${l.toLocaleString()} sats`),n>S&&k.publicKey?(t(n,k.publicKey),z.classList.remove("hidden")):z.classList.add("hidden")}!async function(){S=await e(),_.textContent=S.toLocaleString();const t=localStorage.getItem("walletAddress"),n=localStorage.getItem("walletPublicKey"),s=localStorage.getItem("walletType");if(t&&n&&s){if(k.address=t,k.publicKey=n,k.connected=!0,"xverse"===s){const e=window?.XverseProviders?.BitcoinProvider;if(!e)return i.warning("Xverse wallet not available, please reconnect manually."),void Q();const t=localStorage.getItem("taprootAddress"),n=localStorage.getItem("taprootPublicKey"),s=localStorage.getItem("paymentAddress"),o=localStorage.getItem("paymentPublicKey");if(!(t&&n&&s&&o))return i.warning("Missing Xverse address info ‚Äî please reconnect."),void Q();B={address:t,publicKey:n},T={address:s,publicKey:o},k.taproot=t,k.payment=s}else if("unisat"===s&&!window.unisat)return i.warning("Unisat wallet not available, please reconnect manually."),void Q();Y(s),V(t),I.length||await Z(),""===J.innerHTML.trim()&&await se()}else Q();setInterval(async()=>{await se(),S=await e(),_.textContent=S.toLocaleString()},3e4)}(),$.addEventListener("click",W),P.addEventListener("click",W),A.addEventListener("click",function(){try{k.disconnect?.(),G(),E.clear(),ne.clear(),x=[],I=[],M.innerHTML="",J.innerHTML="",B=null,T=null,Q(),i.info("Wallet disconnected successfully","Disconnected")}catch(e){i.error("Failed to disconnect wallet","Logout Error")}}),X.addEventListener("input",te),j.addEventListener("input",te),O.addEventListener("click",async()=>{try{O.disabled=!0,O.textContent="‚è≥ Creating...";const t=parseInt(X.value),s=parseInt(j.value)||1,a=document.getElementById("airdropAddress")?.value.trim(),r=/^sp1[a-z0-9]{20,80}$/;if(!a)throw new Error("Please enter your Spark wallet address.");if(!r.test(a))throw new Error("Invalid Spark address: must start with sp1...");const d=await e();if(!t||t<=d)throw new Error(`Invalid lock height (current: ${d})`);if(!(k.connected&&k.publicKey||(await k.connect(),k.publicKey)))throw new Error("Missing wallet public key after reconnection");const l=[...E];if(l.length>5)return i.warning("You can only lock a maximum of 5 NFTs per transaction. Please deselect some items.","Too Many NFTs Selected"),O.disabled=!1,void(O.textContent="üîí Create Stake Transaction");const c=`https://open-api.unisat.io/v1/indexer/address/${k.address}/inscription-utxo-data?cursor=0&size=3000`,u=await fetch(c,{headers:{accept:"application/json"}});if(!u.ok)throw new Error(`HTTP ${u.status}`);const p=await u.json(),m=(p.data?.utxo||p.data||[]).filter(e=>l.includes(e.inscriptions?.[0]?.inscriptionId)).map(e=>({txid:e.txid,vout:e.vout,value:Number(e.value??e.satoshi??e.satoshis??0),scriptPk:e.scriptPk||e.scriptPubKey,inscriptionId:e.inscriptions?.[0]?.inscriptionId||null})).filter(e=>e.value>0&&e.scriptPk);if(!m.length)throw new Error("No inscription UTXOs found or missing scriptPk/value.");const g=(await k.getAllUtxos()).filter(e=>e.value>600).sort((e,t)=>t.value-e.value);if(!g.length)throw new Error("No spendable UTXOs available to cover fees.");const h=new n.Psbt({network:n.networks.bitcoin}),f=await fetch("https://omrapi.vercel.app/generate-timelock-others",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nftIds:l,userAddress:k.address,userPublicKey:k.publicKey,lockHeight:t,airdropAddress:a})}),y=await f.json();if(!f.ok||!y.lockAddress)throw new Error(y.error||"Backend timelock failed");const w=y.lockAddress,v=y.salt,b="bc1psjmgv7d28v8eggpjqqwl7uhg4y2t6alcgqytke5y9mst9lt7p3jslk7mys",x=m.length,S=1500,B=[1,.87,.73,.6,.5];let T=0;for(let e=0;e<x;e++)T+=S*(B[e]||1);T=Math.round(T);const L=[380,310,290,250,210][x-1]||210,$=Math.round(L*s*x*.9),P=[];for(const e of m)h.addInput({hash:e.txid,index:e.vout,witnessUtxo:{script:o.from(e.scriptPk,"hex"),value:e.value}}),h.addOutput({address:w,value:e.value}),P.push({nftId:e.inscriptionId,txid:e.txid,vout:e.vout,address:w,value:e.value});const A=$+T,C=g.sort((e,t)=>t.value-e.value);let N=0;const M=[];for(const e of C){if(N>=A)break;N+=e.value,M.push(e)}for(const e of M){const t=o.from(e.scriptPubKey||e.scriptPk,"hex");h.addInput({hash:e.txid,index:e.vout,witnessUtxo:{script:t,value:e.value}})}h.addOutput({address:w,value:$}),h.addOutput({address:b,value:T});const K=m.reduce((e,t)=>e+t.value,0)+M.reduce((e,t)=>e+t.value,0),H=K-(m.reduce((e,t)=>e+t.value,0)+$+T)-Math.ceil((50*h.inputCount+70*h.data.outputs.length)*s*1.1);H>546&&h.addOutput({address:k.address,value:H}),h.setLocktime(t);let F,z=await window.unisat.signPsbt(h.toBase64(),{autoFinalized:!0});if("object"==typeof z)F=z.hex||(z.psbt?n.Psbt.fromBase64(z.psbt).extractTransaction().toHex():null);else if(z.startsWith("cHNidP8"))F=n.Psbt.fromBase64(z).extractTransaction().toHex();else{if(!/^[0-9a-fA-F]+$/.test(z))throw new Error("Unknown Unisat signPsbt format");F=z}if(!F)throw new Error("Failed to extract raw transaction");const U=await window.unisat.pushTx(F),D=l.map(e=>{const t=I.find(t=>t.id===e);let n=100;if(t?.meta?.attributes?.length){const e=t.meta.attributes.find(e=>"Staking Power"===e.trait_type);e&&!isNaN(parseInt(e.value))&&(n=parseInt(e.value))}return{nftId:e,stakingPower:n}});await fetch("https://omrapi.vercel.app/save-timelock-others",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({txid:U,nftIds:l,userAddress:k.address,lockAddress:w,blockHeight:t,stakingData:D,airdropAddress:a,salt:v})});const q=JSON.parse(localStorage.getItem("timelockAddresses")||"[]"),_=P.map(e=>({txid:U,vout:e.vout,nftId:e.nftId||null,lockAddress:w,userAddress:k.address,blockHeight:t,value:e.value||546,nftAmount:e.value||546,bufferAmount:$/x,timestamp:Date.now()})),J=[...q,..._].reduce((e,t)=>{const n=`${t.txid}:${t.vout}`;return e.find(e=>`${e.txid}:${e.vout}`===n)||e.push(t),e},[]);localStorage.setItem("timelockAddresses",JSON.stringify(J)),await se(),E.clear(),await Z(),ee(),i.success(`${x} NFT(s) successfully locked (TXID: ${U.slice(0,8)}‚Ä¶)`,"Stake Transaction Complete",{duration:8e3})}catch(t){i.error(t.message,"Transaction Failed")}finally{O.disabled=!1,O.textContent="üîí Create Stake Transaction"}}),btnTimelockXverse.addEventListener("click",async()=>{try{btnTimelockXverse.disabled=!0,btnTimelockXverse.textContent="‚è≥ Creating...";const t=parseInt(X.value),n=parseInt(j.value)||1,s=document.getElementById("airdropAddress")?.value.trim(),a=/^sp1[a-z0-9]{20,80}$/;if(!s)throw new Error("Please enter your Spark wallet address.");if(!a.test(s))throw new Error("Invalid Spark address: must start with sp1...");if(!B||!T)throw new Error("Connect Xverse first.");const r=await e();if(!t||t<=r)throw new Error(`Invalid lock height (current: ${r})`);const c=[...E];if(0===c.length)throw new Error("Please select at least one NFT to lock.");if(c.length>5)throw new Error("You can only lock up to 5 NFTs per transaction.");const u="https://open-api.unisat.io",p=`${u}/v1/indexer/address/${B.address}/inscription-utxo-data?cursor=0&size=3000`,m=await fetch(p),g=await m.json(),h=(g.data?.utxo||[]).filter(e=>c.includes(e.inscriptions?.[0]?.inscriptionId)).map(e=>({txid:e.txid,vout:e.vout,value:Number(e.value??e.satoshi??0),scriptPk:e.scriptPk||e.scriptPubKey})).filter(e=>e.value>0&&e.scriptPk);if(!h.length)throw new Error("No inscription UTXOs found for selected NFTs.");const f=`${u}/v1/indexer/address/${T.address}/utxo-data?cursor=0&size=300`,y=await fetch(f),w=await y.json(),v=w.data?.utxo?.filter(e=>Number(e.satoshi)>600&&!e.inscriptions?.length)?.sort((e,t)=>t.satoshi-e.satoshi)||[];if(!v.length)throw new Error("No spendable UTXOs available for fees.");const b=await fetch("https://omrapi.vercel.app/generate-timelock",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nftIds:c,userAddress:B.address,userPublicKey:B.publicKey,lockHeight:t,airdropAddress:s})}),x=await b.json();if(!b.ok||!x.lockAddress)throw new Error(x.error||"Backend timelock failed");const S=x.salt,L=x.lockAddress,$="bc1psjmgv7d28v8eggpjqqwl7uhg4y2t6alcgqytke5y9mst9lt7p3jslk7mys",P=h.length,A=1500,C=[1,.87,.73,.6,.5];let N=0;for(let e=0;e<P;e++)N+=A*(C[e]||1);N=Math.round(N);const M=[380,310,290,250,210][P-1]||210,K=Math.round(M*n*P*.9),H=new d({version:2,lockTime:Number(t)}),F=l.decode(B.publicKey),O=(l.decode(T.publicKey),[]);for(const e of h)H.addInput({txid:e.txid,index:e.vout,witnessUtxo:{script:l.decode(e.scriptPk),amount:BigInt(e.value)},tapInternalKey:F}),H.addOutputAddress(L,BigInt(e.value),void 0);let z=0n;const U=[];for(const e of v){if(z>=BigInt(K+N))break;z+=BigInt(e.satoshi),U.push(e)}for(const e of U)H.addInput({txid:e.txid,index:e.vout,witnessUtxo:{script:l.decode(e.scriptPk),amount:BigInt(e.satoshi)}});H.addOutputAddress(L,BigInt(K),void 0),H.addOutputAddress($,BigInt(N));const D=h.reduce((e,t)=>e+BigInt(t.value),0n)+U.reduce((e,t)=>e+BigInt(t.satoshi),0n),q=D-(h.reduce((e,t)=>e+BigInt(t.value),0n)+BigInt(K+N))-BigInt(Math.ceil((50*H.inputs.length+70*H.outputs.length)*n*1.1));q>546n&&H.addOutputAddress(T.address,q,void 0);const _=o.from(H.toPSBT()).toString("base64"),J=window?.XverseProviders?.BitcoinProvider;if(!J)throw new Error("Xverse provider not found");const R=await J.request("signPsbt",{psbt:_,broadcast:!0}),Y=R?.result?.txid||R?.txid;if(!Y)throw new Error("No TXID returned from Xverse");const W=c.map(e=>{const t=I.find(t=>t.id===e);let n=100;if(t?.meta?.attributes?.length){const e=t.meta.attributes.find(e=>"Staking Power"===e.trait_type);e&&!isNaN(parseInt(e.value))&&(n=parseInt(e.value))}return{nftId:e,stakingPower:n}});await fetch("https://omrapi.vercel.app/save-timelock-others",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({txid:Y,nftIds:c,userAddress:B.address,lockAddress:L,blockHeight:t,stakingData:W,airdropAddress:s,salt:S})});const G=JSON.parse(localStorage.getItem("timelockAddresses")||"[]"),V=O.map(e=>({txid:Y,vout:e.vout,nftId:e.nftId||null,lockAddress:L,userAddress:k.address,blockHeight:t,value:e.value||546,nftAmount:e.value||546,bufferAmount:K/P,timestamp:Date.now()})),Q=[...G,...V].reduce((e,t)=>{const n=`${t.txid}:${t.vout}`;return e.find(e=>`${e.txid}:${e.vout}`===n)||e.push(t),e},[]);localStorage.setItem("timelockAddresses",JSON.stringify(Q)),await se(),E.clear(),await Z(),ee(),i.success(`${P} NFT(s) successfully locked (TXID: ${Y.slice(0,8)}‚Ä¶)`,"Stake Transaction Complete",{duration:8e3})}catch(t){i.error(t.message,"Timelock Failed")}finally{btnTimelockXverse.disabled=!1,btnTimelockXverse.textContent="üîí Create Stake (Xverse)"}});let ne=new Set;async function se(){try{const t=document.getElementById("lockedListPanel"),n=document.getElementById("lockedListBody");if(!t||!n)return;const s="https://omrapi.vercel.app",o=localStorage.getItem("walletAddress");if(!o)return;const a=await fetch(`${s}/locksothers?userAddress=${o}`),r=await a.json();if(!a.ok)throw new Error(r.error||"Failed to load locks");const i=await e(),d=144;if(t.classList.remove("hidden"),n.innerHTML="",!r||!r.length)return void(n.innerHTML='\n        <tr>\n          <td colspan="7" style="text-align:center; padding:14px; color:#a1a1aa; font-size:13px;">\n            üö´ No active locks found.<br>\n            <span style="font-size:12px; color:#6b7280;">Stake an NFT to start earning points.</span>\n          </td>\n        </tr>');for(const e of r){const t=i>=(e.blockHeight||0),s=e.nftId?e.nftId.slice(0,8)+"‚Ä¶":"-",o=e.timestamp?new Date(Number(e.timestamp)).toLocaleString():"-",a=((e.blockHeight||0)-i)/d,r=e.lockDays||a;let l,c;if(t)l='<span style="color:#22c55e;">0 days</span>';else{const e=Math.ceil(r);l=`<span style="color:#facc15;">${e<1?`${e} days`:`${parseFloat(r.toFixed(1))} ${"1.0"===r.toFixed(1)?"day":"days"}`}</span>`}c=e.redeemed?'<span class="status-redeemed">üí∏ Redeemed</span>':t?'<span class="status-unlocked">‚úÖ Ready</span>':'<span class="status-locked">‚è≥ Locked</span>';const u=document.createElement("tr");u.innerHTML=`\n        <td>\n          ${e.txid?`<a href="https://mempool.space/tx/${e.txid}" target="_blank" style="color:#f97316;text-decoration:none;font-weight:700;">\n                  ${e.txid.slice(0,6)}‚Ä¶\n                </a>`:'<span style="color:#888;">pending</span>'}\n        </td>\n        <td>${s}</td>\n        <td>${e.blockHeight?.toLocaleString()||"-"}</td>\n        <td>${l}</td>\n        <td>${c}</td>\n        <td>${e.stakingPower?.toLocaleString()||"-"}</td>\n        <td style="font-size:11px;">${o}</td>\n      `,n.appendChild(u)}}catch(t){const e=document.getElementById("lockedListPanel"),n=document.getElementById("lockedListBody");e&&n&&(n.innerHTML=`\n        <tr>\n          <td colspan="7" style="text-align:center; padding:14px; color:#f87171; font-size:13px;">\n            ‚ö†Ô∏è Error loading locks<br>\n            <span style="font-size:12px; color:#9ca3af;">${t.message}</span>\n          </td>\n        </tr>`,e.classList.remove("hidden"))}}
